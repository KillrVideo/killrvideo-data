{
  "video_id": "DZ_of9SrfsM",
  "title": "DS320.47 Spark SQL: Writing Efficient SQL Queries | DataStax Enterprise Analytics",
  "description": "#DataStaxAcademy #DS320\nDS320.47 Spark SQL: Writing Efficient SQL Queries\nIn this course, you will learn how to effectively and efficiently solve analytical problems with Apache Spark™, Apache Cassandra™, and DataStax Enterprise. You will learn about the Spark API, Spark-Cassandra Connector, Spark SQL, Spark Streaming, and crucial performance optimization techniques.  You will also learn the basics of the productive and robust Scala programming language for data analysis and processing in Apache Spark™.\n\nLEARN FOR FREE at https://academy.datastax.com -- access all the FREE complete courses, tutorials, and hands-on exercises.\n\nASK QUESTIONS at https://community.datastax.com -- where experts from DataStax & the Apache Cassandra community share their expertise everyday.",
  "published_at": "2020-08-16T00:34:44Z",
  "thumbnail": "https://i.ytimg.com/vi/DZ_of9SrfsM/maxresdefault.jpg",
  "channel_title": "DataStax Developers",
  "channel_id": "UCAIQY251avaMv7bBv5PCo-A",
  "tags": [
    "cassandra",
    "tutorial",
    "apache_cassandra",
    "performance",
    "datastax"
  ],
  "url": "https://www.youtube.com/watch?v=DZ_of9SrfsM",
  "transcript": {
    "available": true,
    "language": "English (auto-generated)",
    "language_code": "en",
    "is_generated": true,
    "text": "[Music] while spark sql gives you a tremendous amount of power to perform arbitrary kinds of queries in sql on data that's in cassandra tables it still pays to think a little bit about the structure of the cassandra tables and the kinds of queries you're doing because the sparca sander connector will push predicates down when possible if a query can be done in cassandra it's always going to be faster than spark doing it if it can't be done in cassandra then that's fine we should let spark do what it does but when it can be done cassandra will always do these things faster and that's what predicate push down means when you've got a where clause that has predicates in it the spark cassandra connector will push those down into cassandra when possible and have cassandra do that work much more efficiently than return a smaller data set up into spark for further analysis let me give you a couple of examples of two kinds of predicate push down clustering key push down and partition key push down and we'll just give you a little bit of an idea how to think about these this stuff again should be in your mind as you're designing your queries because you'd like push down to happen if possible now push down is enabled automatically you have to stop it if you don't want it to be happening but for it to work you have to choose your tables wisely now in this case with this query we're looking for release here and title of all of the johnny depp movies that were released before 2015 we could satisfy that query by actors by movie or movies by actor spark sequel will do both of them our choice is significant though what you should do right now is go ahead and pause the video take a look here and make a prediction about which one of these is going to be more efficient to answer the question you have to understand the cassandra data model fairly well if you look at the actor column in actors by movie it's a clustering key it's not a part of the partition key so what spark is going to have to do is get these results from every node in the cassandra cluster that's going to take a lot of work that's not going to be an efficient query at all movies by actor we see actor is the partition key and release here is a clustering key so both of the columns in the predicate actor and release here can get pushed down into cassandra this query can actually be satisfied as a cql query and not even a spark sql query so predicate pushdown really is our friend if we choose the table correctly that's the thing that we have to do when we're designing our queries so here's an example of only the clustering key being able to be pushed as you can see the partition key of actors by movie which is the table being queried here is movie id and in our predicate we only have actor and release here so spark will have to do a scatter gather type of query we show this query in both forms both the sql version and the language integrated version but in both cases it produces basically the same results and does it not very efficiently so this would be considered an anti-pattern if we had a better table available to satisfy the same query and so we do in the table movies by actor where actor is the partition key that means both of the predicate columns actor and release here are both pushed down to cassandra and cassandra has a good query that satisfies the partition key and one of its clustering keys you'll notice compared to the last slide we don't specify any ordering here because we know looking at our schema that release here is a clustering key and we'll see results ordered by release year whether we want them to be or not so it pays to know something about your cassandra schema and know something about the cassandra data model when you're writing spark sql queries the whole point of spark sql is that it does free you from cql and give you access to capabilities that cql doesn't have but your queries will run faster if you keep your cassandra data model in mind [Music] you",
    "segments": [
      {
        "start": 0.06,
        "duration": 3.45,
        "text": "[Music]"
      },
      {
        "start": 7.6,
        "duration": 2.56,
        "text": "while spark sql gives you a tremendous"
      },
      {
        "start": 9.36,
        "duration": 4.319,
        "text": "amount of power"
      },
      {
        "start": 10.16,
        "duration": 6.32,
        "text": "to perform arbitrary kinds of queries in"
      },
      {
        "start": 13.679,
        "duration": 4.561,
        "text": "sql on data that's in cassandra tables"
      },
      {
        "start": 16.48,
        "duration": 3.28,
        "text": "it still pays to think a little bit"
      },
      {
        "start": 18.24,
        "duration": 3.039,
        "text": "about the structure of the cassandra"
      },
      {
        "start": 19.76,
        "duration": 2.0,
        "text": "tables and the kinds of queries you're"
      },
      {
        "start": 21.279,
        "duration": 2.881,
        "text": "doing"
      },
      {
        "start": 21.76,
        "duration": 3.839,
        "text": "because the sparca sander connector will"
      },
      {
        "start": 24.16,
        "duration": 4.32,
        "text": "push predicates down"
      },
      {
        "start": 25.599,
        "duration": 4.881,
        "text": "when possible if a query can be done in"
      },
      {
        "start": 28.48,
        "duration": 3.039,
        "text": "cassandra it's always going to be faster"
      },
      {
        "start": 30.48,
        "duration": 2.56,
        "text": "than spark doing it"
      },
      {
        "start": 31.519,
        "duration": 3.281,
        "text": "if it can't be done in cassandra then"
      },
      {
        "start": 33.04,
        "duration": 2.4,
        "text": "that's fine we should let spark do what"
      },
      {
        "start": 34.8,
        "duration": 2.64,
        "text": "it does"
      },
      {
        "start": 35.44,
        "duration": 3.439,
        "text": "but when it can be done cassandra will"
      },
      {
        "start": 37.44,
        "duration": 2.88,
        "text": "always do these things faster and that's"
      },
      {
        "start": 38.879,
        "duration": 2.961,
        "text": "what predicate push down means"
      },
      {
        "start": 40.32,
        "duration": 3.04,
        "text": "when you've got a where clause that has"
      },
      {
        "start": 41.84,
        "duration": 2.16,
        "text": "predicates in it the spark cassandra"
      },
      {
        "start": 43.36,
        "duration": 3.12,
        "text": "connector"
      },
      {
        "start": 44.0,
        "duration": 3.12,
        "text": "will push those down into cassandra when"
      },
      {
        "start": 46.48,
        "duration": 2.399,
        "text": "possible"
      },
      {
        "start": 47.12,
        "duration": 3.84,
        "text": "and have cassandra do that work much"
      },
      {
        "start": 48.879,
        "duration": 3.441,
        "text": "more efficiently than return a smaller"
      },
      {
        "start": 50.96,
        "duration": 3.2,
        "text": "data set up into spark"
      },
      {
        "start": 52.32,
        "duration": 3.44,
        "text": "for further analysis let me give you a"
      },
      {
        "start": 54.16,
        "duration": 2.719,
        "text": "couple of examples of two kinds of"
      },
      {
        "start": 55.76,
        "duration": 2.959,
        "text": "predicate push down"
      },
      {
        "start": 56.879,
        "duration": 3.36,
        "text": "clustering key push down and partition"
      },
      {
        "start": 58.719,
        "duration": 2.881,
        "text": "key push down and we'll just give you a"
      },
      {
        "start": 60.239,
        "duration": 1.761,
        "text": "little bit of an idea how to think about"
      },
      {
        "start": 61.6,
        "duration": 3.04,
        "text": "these"
      },
      {
        "start": 62.0,
        "duration": 4.32,
        "text": "this stuff again should be in your mind"
      },
      {
        "start": 64.64,
        "duration": 2.32,
        "text": "as you're designing your queries because"
      },
      {
        "start": 66.32,
        "duration": 3.44,
        "text": "you'd like"
      },
      {
        "start": 66.96,
        "duration": 4.4,
        "text": "push down to happen if possible now push"
      },
      {
        "start": 69.76,
        "duration": 3.039,
        "text": "down is enabled automatically you have"
      },
      {
        "start": 71.36,
        "duration": 2.16,
        "text": "to stop it if you don't want it to be"
      },
      {
        "start": 72.799,
        "duration": 2.32,
        "text": "happening"
      },
      {
        "start": 73.52,
        "duration": 3.12,
        "text": "but for it to work you have to choose"
      },
      {
        "start": 75.119,
        "duration": 3.36,
        "text": "your tables wisely"
      },
      {
        "start": 76.64,
        "duration": 3.76,
        "text": "now in this case with this query we're"
      },
      {
        "start": 78.479,
        "duration": 3.521,
        "text": "looking for release here and title"
      },
      {
        "start": 80.4,
        "duration": 4.0,
        "text": "of all of the johnny depp movies that"
      },
      {
        "start": 82.0,
        "duration": 5.2,
        "text": "were released before 2015"
      },
      {
        "start": 84.4,
        "duration": 3.68,
        "text": "we could satisfy that query by actors by"
      },
      {
        "start": 87.2,
        "duration": 4.0,
        "text": "movie or"
      },
      {
        "start": 88.08,
        "duration": 5.84,
        "text": "movies by actor spark sequel will do"
      },
      {
        "start": 91.2,
        "duration": 3.2,
        "text": "both of them our choice is significant"
      },
      {
        "start": 93.92,
        "duration": 2.32,
        "text": "though"
      },
      {
        "start": 94.4,
        "duration": 3.12,
        "text": "what you should do right now is go ahead"
      },
      {
        "start": 96.24,
        "duration": 3.36,
        "text": "and pause the video"
      },
      {
        "start": 97.52,
        "duration": 3.52,
        "text": "take a look here and make a prediction"
      },
      {
        "start": 99.6,
        "duration": 3.6,
        "text": "about which one of these is going to be"
      },
      {
        "start": 101.04,
        "duration": 3.52,
        "text": "more efficient"
      },
      {
        "start": 103.2,
        "duration": 3.279,
        "text": "to answer the question you have to"
      },
      {
        "start": 104.56,
        "duration": 3.839,
        "text": "understand the cassandra data model"
      },
      {
        "start": 106.479,
        "duration": 4.0,
        "text": "fairly well if you look at the actor"
      },
      {
        "start": 108.399,
        "duration": 3.201,
        "text": "column in actors by movie it's a"
      },
      {
        "start": 110.479,
        "duration": 3.521,
        "text": "clustering key"
      },
      {
        "start": 111.6,
        "duration": 4.0,
        "text": "it's not a part of the partition key so"
      },
      {
        "start": 114.0,
        "duration": 4.56,
        "text": "what spark is going to have to do"
      },
      {
        "start": 115.6,
        "duration": 4.32,
        "text": "is get these results from every node in"
      },
      {
        "start": 118.56,
        "duration": 2.72,
        "text": "the cassandra cluster that's going to"
      },
      {
        "start": 119.92,
        "duration": 1.839,
        "text": "take a lot of work that's not going to"
      },
      {
        "start": 121.28,
        "duration": 2.72,
        "text": "be"
      },
      {
        "start": 121.759,
        "duration": 3.68,
        "text": "an efficient query at all movies by"
      },
      {
        "start": 124.0,
        "duration": 4.399,
        "text": "actor we see actor"
      },
      {
        "start": 125.439,
        "duration": 3.281,
        "text": "is the partition key and release here is"
      },
      {
        "start": 128.399,
        "duration": 2.401,
        "text": "a"
      },
      {
        "start": 128.72,
        "duration": 3.28,
        "text": "clustering key so both of the columns in"
      },
      {
        "start": 130.8,
        "duration": 2.88,
        "text": "the predicate actor"
      },
      {
        "start": 132.0,
        "duration": 3.36,
        "text": "and release here can get pushed down"
      },
      {
        "start": 133.68,
        "duration": 2.639,
        "text": "into cassandra this query can actually"
      },
      {
        "start": 135.36,
        "duration": 3.92,
        "text": "be satisfied"
      },
      {
        "start": 136.319,
        "duration": 4.56,
        "text": "as a cql query and not even a spark sql"
      },
      {
        "start": 139.28,
        "duration": 2.319,
        "text": "query so predicate pushdown really is"
      },
      {
        "start": 140.879,
        "duration": 2.72,
        "text": "our friend"
      },
      {
        "start": 141.599,
        "duration": 3.761,
        "text": "if we choose the table correctly that's"
      },
      {
        "start": 143.599,
        "duration": 3.681,
        "text": "the thing that we have to do"
      },
      {
        "start": 145.36,
        "duration": 3.36,
        "text": "when we're designing our queries so"
      },
      {
        "start": 147.28,
        "duration": 4.08,
        "text": "here's an example of"
      },
      {
        "start": 148.72,
        "duration": 3.2,
        "text": "only the clustering key being able to be"
      },
      {
        "start": 151.36,
        "duration": 2.239,
        "text": "pushed"
      },
      {
        "start": 151.92,
        "duration": 4.56,
        "text": "as you can see the partition key of"
      },
      {
        "start": 153.599,
        "duration": 4.64,
        "text": "actors by movie which is the table being"
      },
      {
        "start": 156.48,
        "duration": 3.759,
        "text": "queried here is movie id"
      },
      {
        "start": 158.239,
        "duration": 3.041,
        "text": "and in our predicate we only have actor"
      },
      {
        "start": 160.239,
        "duration": 2.961,
        "text": "and release here"
      },
      {
        "start": 161.28,
        "duration": 3.36,
        "text": "so spark will have to do a scatter"
      },
      {
        "start": 163.2,
        "duration": 3.6,
        "text": "gather type of query"
      },
      {
        "start": 164.64,
        "duration": 3.36,
        "text": "we show this query in both forms both"
      },
      {
        "start": 166.8,
        "duration": 3.04,
        "text": "the sql version"
      },
      {
        "start": 168.0,
        "duration": 3.519,
        "text": "and the language integrated version but"
      },
      {
        "start": 169.84,
        "duration": 2.8,
        "text": "in both cases it produces basically the"
      },
      {
        "start": 171.519,
        "duration": 3.601,
        "text": "same results and"
      },
      {
        "start": 172.64,
        "duration": 4.16,
        "text": "does it not very efficiently so this"
      },
      {
        "start": 175.12,
        "duration": 3.839,
        "text": "would be considered an anti-pattern if"
      },
      {
        "start": 176.8,
        "duration": 4.64,
        "text": "we had a better table available"
      },
      {
        "start": 178.959,
        "duration": 4.801,
        "text": "to satisfy the same query and so we do"
      },
      {
        "start": 181.44,
        "duration": 3.439,
        "text": "in the table movies by actor where actor"
      },
      {
        "start": 183.76,
        "duration": 2.72,
        "text": "is the partition key"
      },
      {
        "start": 184.879,
        "duration": 3.28,
        "text": "that means both of the predicate columns"
      },
      {
        "start": 186.48,
        "duration": 3.52,
        "text": "actor and release here are both pushed"
      },
      {
        "start": 188.159,
        "duration": 3.36,
        "text": "down to cassandra and cassandra has a"
      },
      {
        "start": 190.0,
        "duration": 3.2,
        "text": "good query that satisfies"
      },
      {
        "start": 191.519,
        "duration": 3.44,
        "text": "the partition key and one of its"
      },
      {
        "start": 193.2,
        "duration": 2.64,
        "text": "clustering keys you'll notice compared"
      },
      {
        "start": 194.959,
        "duration": 3.121,
        "text": "to the last slide"
      },
      {
        "start": 195.84,
        "duration": 3.759,
        "text": "we don't specify any ordering here"
      },
      {
        "start": 198.08,
        "duration": 3.36,
        "text": "because we know looking at our schema"
      },
      {
        "start": 199.599,
        "duration": 3.521,
        "text": "that release here is a clustering key"
      },
      {
        "start": 201.44,
        "duration": 3.6,
        "text": "and we'll see results ordered by release"
      },
      {
        "start": 203.12,
        "duration": 3.44,
        "text": "year whether we want them to be or not"
      },
      {
        "start": 205.04,
        "duration": 3.44,
        "text": "so it pays to know something about your"
      },
      {
        "start": 206.56,
        "duration": 3.92,
        "text": "cassandra schema and know something"
      },
      {
        "start": 208.48,
        "duration": 3.679,
        "text": "about the cassandra data model"
      },
      {
        "start": 210.48,
        "duration": 3.759,
        "text": "when you're writing spark sql queries"
      },
      {
        "start": 212.159,
        "duration": 2.561,
        "text": "the whole point of spark sql is that it"
      },
      {
        "start": 214.239,
        "duration": 3.121,
        "text": "does"
      },
      {
        "start": 214.72,
        "duration": 4.32,
        "text": "free you from cql and give you access to"
      },
      {
        "start": 217.36,
        "duration": 3.84,
        "text": "capabilities that cql"
      },
      {
        "start": 219.04,
        "duration": 4.0,
        "text": "doesn't have but your queries will run"
      },
      {
        "start": 221.2,
        "duration": 6.64,
        "text": "faster if you keep your cassandra data"
      },
      {
        "start": 223.04,
        "duration": 4.8,
        "text": "model in mind"
      },
      {
        "start": 227.9,
        "duration": 5.3,
        "text": "[Music]"
      },
      {
        "start": 231.12,
        "duration": 2.08,
        "text": "you"
      }
    ],
    "error": null,
    "error_type": null
  },
  "collected_at": "2025-12-15T23:07:18.619440+00:00"
}